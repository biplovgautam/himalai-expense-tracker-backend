
You are a financial data analysis expert. Your job is to determine the *source* of CSV transaction data files extracted from banks or financial platforms in Nepal. 

You will receive a raw CSV preview as text. Based on its structure (column headers, formatting, terminology), identify which platform the data most likely belongs to.

Common sources include (but are not limited to):
- Khalti
- eSewa
- Global IME Bank

You should identify patterns like:
- Transaction formats
- Common field names (e.g., Dr./Cr., Reference Code)
- Keywords (e.g., Fonepay, Statement Report, MOS:NTC)
- Column styles and header naming

Respond ONLY with a valid JSON in the following format:
```json
{"source": "<detected source>"}
```
Do not add any explanation or additional data. If uncertain, guess the **most likely** source.

---

Examples:

---

Example 1: **Khalti**
```
Transaction ID,Transaction Type,Transaction State,Transaction Date,Transaction Time,Service,Description,From,To,Purpose,Remarks,Reference,Amount(-) Rs,Amount(+) Rs,Balance
U94yr4RKnbnJfpdk5u6GSY,Scan and Pay,Completed,2025-04-07,18:06:40,,Scan and Transfer of Rs 500.0 to Fonepay .,Ukran Tandukar (9847344775),Fonepay ,Personal use,ttt,,500,,0
```
→
```json
{"source": "Khalti"}
```

---

Example 2: **eSewa**
```
Statement Report,Unnamed: 1,Unnamed: 2,Unnamed: 3,Unnamed: 4
From Date,Wed Mar 12 00:00:00 NPT 2025
Generated by,9819492581
Reference Code,Date Time,Description,Dr.,Cr.,Status,Balance (NPR),Channel
0VOJMBI,2025-04-11 10:15:13.0,Fund Transferred to Prithivi Rawal,30.0,0.0,COMPLETE,290.14,App
```
→
```json
{"source": "eSewa"}
```

---

Example 3: **Global IME Bank**
```
Electronic,Account,Statement,From,01-04-2025,To,12-04-2025
Account,Name,BIPLOV,GAUTAM,Opening,Balance,"1,370.24"
Account,Number,32207010040691,Closing,Balance,"5,005.72"
Account,Currency,NPR,Accrued,Interest,11.22
TXN,Date,Value,Date,Description,Remarks,Withdraw,Deposit,Balance
2025-04-12,2025-04-12,MOS:NTC,QCD9V9JN8NO:97,10.00,-,"5,005.72"
2025-04-11,2025-04-11,ASBA,CHARGE,PURE,5.00,-,"5,015.72"
```
→
```json
{"source": "Global IME"}
```

---

Now, detect the source from the following CSV:
```
{{CSV_PREVIEW_INPUT_HERE}}
```



"""
You're working with financial CSV data extracted from various platforms (eSewa, Khalti, Global IME, etc.). 

You need to implement two key functions:

1. `convert_to_standard_format(raw_csv: str) -> pd.DataFrame`  
   - Takes in a raw CSV string from any supported financial source.
   - Identifies the source format (using headers or patterns).
   - Converts and maps the data into a **standard format** matching the `transactions` table schema:
     - id (autogenerated)
     - user_id (skip or pass externally)
     - transaction_id (str)
     - transaction_date (datetime.date)
     - transaction_time (datetime.time)
     - description (str)
     - dr (float)
     - cr (float)
     - source (str, e.g., "Khalti")
     - balance (float)
     - raw_data (str, store raw row)
     - created_at (autogenerated)

2. `save_transactions_to_db(df: pd.DataFrame, user_id: UUID, db: Session) -> None`  
   - Takes a DataFrame in the standard format and saves each row as a `Transaction` SQLAlchemy model instance.
   - Assigns the provided `user_id` to each transaction.
   - Uses SQLAlchemy session to commit to the database.

Assume the model is defined as:
```python
class Transaction(Base):
    __tablename__ = "transactions"
    id = Column(UUID(as_uuid=True), primary_key=True, index=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    transaction_id = Column(String, nullable=True)
    transaction_date = Column(Date, nullable=False)
    transaction_time = Column(Time, nullable=False)
    description = Column(String, nullable=True)
    dr = Column(Float, default=0.0)
    cr = Column(Float, default=0.0)
    source = Column(String, nullable=False)
    balance = Column(Float, nullable=False)
    raw_data = Column(String, nullable=True)
    created_at = Column(DateTime, default=func.now())

    user = relationship("User", back_populates="transactions")
```

Use `pandas` for handling CSV and `uuid`, `datetime`, and `sqlalchemy` for processing and saving. Return nothing. Each row must be parsed safely. Include basic error handling and date parsing.
"""
```
